import pandas as pd
import numpy as np
from typing import Dict, Set, Tuple
import json

def compare_procedure_results(oracle_csv: str, llm_csv: str, 
                              decimal_places: int = 2) -> Dict:
    """
    오라클 전문가 프로시저 결과와 LLM 변환 프로시저 결과를 비교하여 정확도를 산출
    소수점 데이터는 지정된 자리수까지만 비교
    
    Parameters:
    -----------
    oracle_csv : str
        오라클 전문가가 작성한 프로시저 결과 CSV 파일 경로
    llm_csv : str
        LLM으로 변환한 프로시저 결과 CSV 파일 경로
    decimal_places : int
        소수점 비교 자리수 (기본값: 2)
    """
    
    # CSV 파일 로드
    print("CSV 파일 로드 중...")
    df_oracle = pd.read_csv(oracle_csv, low_memory=False)
    df_llm = pd.read_csv(llm_csv, low_memory=False)
    
    # 컬럼명을 소문자로 통일 (대소문자 구분 제거)
    df_oracle.columns = df_oracle.columns.str.lower()
    df_llm.columns = df_llm.columns.str.lower()
    
    print(f"오라클 전문가 결과: {len(df_oracle):,}건")
    print(f"LLM 변환 결과: {len(df_llm):,}건")
    
    # 컬럼 순서 확인 및 정렬
    if set(df_oracle.columns) != set(df_llm.columns):
        print("\n⚠️  경고: 컬럼 구성이 다릅니다!")
        print(f"오라클 전용 컬럼: {set(df_oracle.columns) - set(df_llm.columns)}")
        print(f"LLM 전용 컬럼: {set(df_llm.columns) - set(df_oracle.columns)}")
        return None
    
    # 컬럼 순서를 오라클 기준으로 통일
    df_llm = df_llm[df_oracle.columns]
    
    # 데이터 정규화
    print(f"\n데이터 정규화 중 (소수점 {decimal_places}자리 기준, null 통일 처리)...")
    df_oracle_normalized = normalize_dataframe(df_oracle, decimal_places)
    df_llm_normalized = normalize_dataframe(df_llm, decimal_places)
    
    # 전체 레코드를 튜플로 변환하여 비교
    print("레코드 매칭 중...")
    oracle_records = set(df_oracle_normalized.apply(lambda row: tuple(row), axis=1))
    llm_records = set(df_llm_normalized.apply(lambda row: tuple(row), axis=1))
    
    # 교집합, 차집합 계산
    matching_records = oracle_records & llm_records  # 완전 일치
    only_in_oracle = oracle_records - llm_records    # 누락된 데이터
    only_in_llm = llm_records - oracle_records       # 잘못 추가된 데이터
    
    # 정확도 지표 계산
    num_matching = len(matching_records)
    num_oracle = len(oracle_records)
    num_llm = len(llm_records)
    num_only_oracle = len(only_in_oracle)
    num_only_llm = len(only_in_llm)
    
    # 완전 일치율만 계산
    match_rate = num_matching / num_oracle * 100 if num_oracle > 0 else 0
    
    # 결과 딕셔너리 생성
    results = {
        "summary": {
            "oracle_total": num_oracle,
            "llm_total": num_llm,
            "matching": num_matching,
            "not_matching_oracle": num_only_oracle,
            "not_matching_llm": num_only_llm,
            "match_rate": round(match_rate, 2)
        }
    }
    
    # 결과 출력
    print_results(results)
    
    # 불일치 레코드만 저장
    save_mismatched_records(df_oracle, df_llm, df_oracle_normalized, df_llm_normalized,
                           only_in_oracle, only_in_llm)
    
    return results


def normalize_value(value):
    """
    개별 값을 정규화
    - null, NaN, None, "", ".", "nan" 등을 모두 빈 문자열로 통일
    - 숫자의 trailing zeros 제거
    """
    # None, NaN 체크
    if value is None or pd.isna(value):
        return ""
    
    # 문자열로 변환
    str_value = str(value).strip()
    
    # null 계열 값들을 빈 문자열로 통일
    if str_value.lower() in ['', '.', 'nan', 'none', 'null', 'na']:
        return ""
    
    # 숫자인 경우 trailing zeros 제거
    try:
        f = float(str_value)
        if f.is_integer():
            return str(int(f))
        # trailing zeros 제거
        return ('%f' % f).rstrip('0').rstrip('.')
    except:
        return str_value


def normalize_dataframe(df: pd.DataFrame, decimal_places: int) -> pd.DataFrame:
    """
    데이터프레임을 정규화
    - 소수점 데이터는 지정된 자리수로 반올림
    - null, "", ".", "nan" 등을 모두 빈 문자열로 통일
    - 문자열은 공백 제거
    """
    df_normalized = df.copy()
    
    for col in df_normalized.columns:
        # 숫자형 컬럼 처리
        if pd.api.types.is_numeric_dtype(df_normalized[col]):
            # 소수점이 있는 경우만 반올림
            if df_normalized[col].dtype in [np.float64, np.float32]:
                df_normalized[col] = df_normalized[col].round(decimal_places)
        
        # 모든 값을 정규화된 문자열로 변환
        df_normalized[col] = df_normalized[col].apply(normalize_value)
    
    return df_normalized


def save_mismatched_records(df_oracle: pd.DataFrame, df_llm: pd.DataFrame,
                           df_oracle_normalized: pd.DataFrame, 
                           df_llm_normalized: pd.DataFrame,
                           only_in_oracle: Set[Tuple], 
                           only_in_llm: Set[Tuple]):
    """불일치하는 레코드만 Oracle과 LLM별로 저장"""
    print("\n불일치 레코드 저장 중...")
    
    # Oracle에만 있는 레코드 (LLM에서 누락되거나 다른 값)
    if only_in_oracle:
        oracle_mismatched = []
        for i, row in df_oracle_normalized.iterrows():
            if tuple(row) in only_in_oracle:
                oracle_mismatched.append(df_oracle.iloc[i])
        
        if oracle_mismatched:
            df_oracle_mismatch = pd.DataFrame(oracle_mismatched)
            df_oracle_mismatch.to_csv('oracle_mismatched.csv', index=False, encoding='utf-8-sig')
            print(f"  ✓ Oracle 불일치 레코드: oracle_mismatched.csv ({len(df_oracle_mismatch):,}건)")
    
    # LLM에만 있는 레코드 (잘못 추가되거나 다른 값)
    if only_in_llm:
        llm_mismatched = []
        for i, row in df_llm_normalized.iterrows():
            if tuple(row) in only_in_llm:
                llm_mismatched.append(df_llm.iloc[i])
        
        if llm_mismatched:
            df_llm_mismatch = pd.DataFrame(llm_mismatched)
            df_llm_mismatch.to_csv('llm_mismatched.csv', index=False, encoding='utf-8-sig')
            print(f"  ✓ LLM 불일치 레코드: llm_mismatched.csv ({len(df_llm_mismatch):,}건)")
    
    print("\n✓ 불일치 레코드 저장 완료!")


def print_results(results: Dict):
    """분석 결과를 보기 좋게 출력"""
    print("\n" + "="*70)
    print("프로시저 정확도 분석 결과")
    print("="*70)
    
    summary = results['summary']
    
    print("\n[레코드 수 요약]")
    print(f"  Oracle 전체:        {summary['oracle_total']:>10,}건")
    print(f"  LLM 전체:           {summary['llm_total']:>10,}건")
    print(f"  완전 일치:          {summary['matching']:>10,}건")
    print(f"  Oracle 불일치:      {summary['not_matching_oracle']:>10,}건")
    print(f"  LLM 불일치:         {summary['not_matching_llm']:>10,}건")
    
    print("\n[완전 일치율]")
    print(f"  일치율:             {summary['match_rate']:>10.2f}%")
    
    print("="*70 + "\n")


# 사용 예시
if __name__ == "__main__":
    # 함수 호출
    results = compare_procedure_results(
        oracle_csv='./data_csv/post/tb_t18_molt088.csv',
        llm_csv='./data_csv/llm/tb_t18_molt088.csv',
        decimal_places=2  # 소수점 2자리까지만 비교
    )
    
    if results:
        # 결과를 JSON 파일로도 저장
        with open('comparison_results.json', 'w', encoding='utf-8') as f:
            json.dump(results, f, indent=2, ensure_ascii=False)
        print("✓ 상세 결과가 comparison_results.json에 저장되었습니다.")
